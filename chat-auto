#!/bin/bash

# Default values for optional flags
MODE=""

# Prompt for the username
read -p "Enter your username: " USERNAME
if [[ -z "$USERNAME" ]]; then
    echo "Error: Username cannot be empty."
    exit 1
fi

# Prompt for the mode (optional)
read -p "Enter mode (bot or manuel, leave empty for no mode): " MODE

# Build the command
CMD="./chat $USERNAME"  # The username is a required argument

# Append the mode if provided
if [[ -n "$MODE" ]]; then
    CMD="$CMD --$MODE"
fi

# Create a named pipe for communication
PIPE_NAME="/tmp/chat_pipe"
if [[ ! -p "$PIPE_NAME" ]]; then
    mkfifo "$PIPE_NAME"
fi

# Run the client program with the command, redirecting input from the pipe
$CMD < "$PIPE_NAME" &  # Run the chat client in the background
CLIENT_PID=$!

# Wait for the client to initialize before continuing
sleep 1

# Function to prompt for the recipient's username
prompt_for_recipient() {
    read -p "Enter the recipient's username: " RECIPIENT
    if [[ -z "$RECIPIENT" ]]; then
        echo "No recipient specified, exiting."
        kill "$CLIENT_PID"
        rm "$PIPE_NAME"
        exit 0
    fi
}

# Initial recipient prompt
prompt_for_recipient

# Loop to read and send individual messages
while true; do
    echo "Enter your message (Ctrl+D to change recipient):"
    if ! IFS= read -r MESSAGE; then
        prompt_for_recipient
        continue
    fi
    if [[ -z "$MESSAGE" ]]; then
        continue
    fi

    MESSAGE="$RECIPIENT $MESSAGE"
    echo -e "$MESSAGE" > "$PIPE_NAME"
done

# Cleanup on exit
kill "$CLIENT_PID"
rm "$PIPE_NAME"
