#!/bin/bash

# Default values for optional flags
MODE=""

# Prompt for the username
read -p "Enter your username: " USERNAME
if [[ -z "$USERNAME" ]]; then
    echo "Error: Username cannot be empty."
    exit 1
fi

# Prompt for the mode (optional)
read -p "Enter mode (bot or manuel, leave empty for no mode): " MODE

# Build the command
CMD="./chat $USERNAME"  # The username is a required argument

# Append the mode if provided
if [[ -n "$MODE" ]]; then
    CMD="$CMD --$MODE"
fi

# Function to prompt for the recipient's username
prompt_for_recipient() {
    read -p "Enter the recipient's username: " RECIPIENT
    if [[ -z "$RECIPIENT" ]]; then
        echo "No recipient specified, exiting."
        exit 0
    fi
}

# Run the client program with the command
eval $CMD &  # Run the chat client in the background
CLIENT_PID=$!

# Wait for the client to initialize before continuing
sleep 1

# Initial recipient prompt
prompt_for_recipient

# Loop to read and send individual messages
while true; do
    # Read the message input
    echo "Enter your message (Ctrl+D to change recipient):"
    
    # Read a single line message
    if ! IFS= read -r MESSAGE; then
        # If Ctrl+D is pressed or input is empty, prompt for a new recipient or exit
        prompt_for_recipient
        continue
    fi

    # If the message is empty, continue the loop
    if [[ -z "$MESSAGE" ]]; then
        continue
    fi

    # Prepend the recipient's username to the message
    MESSAGE="$RECIPIENT $MESSAGE"

    # Send the message to the chat program (the client's stdin)
    echo -e "$MESSAGE" > /proc/$CLIENT_PID/fd/0
done
