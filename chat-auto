#!/bin/bash

# Valeurs par défaut pour les options facultatives
MODE=""

# Demander le nom d'utilisateur
read -p "Entrez votre nom d'utilisateur : " USERNAME
if [[ -z "$USERNAME" ]]; then
    echo "Erreur : Le nom d'utilisateur ne peut pas être vide."
    exit 1
fi

# Demander le mode (facultatif)
read -p "Entrez le mode (bot ou manuel, laissez vide pour aucun mode) : " MODE

# Construire la commande
CMD="./chat $USERNAME"  # Le nom d'utilisateur est un argument obligatoire

# Ajouter le mode si fourni
if [[ -n "$MODE" ]]; then
    CMD="$CMD --$MODE"
fi

# Fonction pour demander le nom d'utilisateur du destinataire
prompt_recipient() {
    read -p "Entrez le nom d'utilisateur du destinataire : " RECIPIENT
    if [[ -z "$RECIPIENT" ]]; then
        echo "Aucun destinataire spécifié, sortie."
        exit 0
    fi
}

# Exécuter le programme client avec la commande
eval $CMD &  # Lancer le client de chat en arrière-plan
CLIENT_PID=$!

# Attendre que le client s'initialise avant de continuer
sleep 1

# Demande initiale du destinataire
prompt_recipient

# Boucle pour lire et envoyer des messages individuels
while true; do
    # Lire l'entrée du message
    echo "Entrez votre message (Ctrl+D pour changer de destinataire) :"
    
    # Lire un message sur une seule ligne
    if ! IFS= read -r MESSAGE; then
        # Si Ctrl+D est pressé ou si l'entrée est vide, demander un nouveau destinataire ou sortir
        prompt_recipient
        continue
    fi

    # Si le message est vide, continuer la boucle
    if [[ -z "$MESSAGE" ]]; then
        continue
    fi

    # Ajouter le nom d'utilisateur du destinataire au message
    MESSAGE="$RECIPIENT $MESSAGE"

    # Envoyer le message au programme de chat (stdin du client)
    echo -e "$MESSAGE" > /proc/$CLIENT_PID/fd/0
done
